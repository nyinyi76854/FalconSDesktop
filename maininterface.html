<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Falcon S Powered by Genix</title>
    <link rel="icon" type="image/x-icon" href="FalconS.ico">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    

</head>
<body>
   <div class="main-container">
       <button id="sidebarToggle" class="sidebar-toggle">
        <i class="fas fa-bars"></i> <!-- Sidebar icon -->
    </button>
<!-- Dialog for Creating Group -->
<div id="createGroupDialog" class="create-group-dialog" style="display: none;">
    <div class="create-group-content">
        <h2>Create Group</h2>
        <input type="text" id="groupName" placeholder="Enter group name">
        
        <div class="dialog-buttons">
            <button id="saveGroupButton">Save</button>
            <button id="cancelGroupButton">Cancel</button>
        </div>
    </div>
</div>
<!-- Start Exploring Host Button -->
<button id="exploreHostBtn" class="explore-host-btn">Start Exploring Host</button>

        <!-- Left section with profile and chat items -->
        <div class="left-section">
    <!-- Chat Type Selection -->
    <div class="chat-type-selection">
        <button id="personalChatBtn" class="chat-type-btn active">
            <i class="fas fa-user"></i> Personal Chat
        </button>
        <button id="groupChatBtn" class="chat-type-btn">
            <i class="fas fa-users"></i> Group Chat
        </button>
    </div>

    <!-- Chat Items Container -->
    <div id="chatItemsContainer"></div>

</div>




      <!-- Right section with account information -->
<div class="right-section">
<button id="searchButton" class="search-button" onclick="navigateToSearch()">
    <i class="fas fa-search"></i>
</button>
 <div class="create-button-container">
        <button id="createButton" class="create-button">
            <i class="fas fa-plus-circle"></i> <!-- Plus icon for create -->
        </button>
    </div>
    <div class="account-info">
        <div class="profile-container">
            <img id="currentUserProfilePhoto" class="profile-photo" src="user_1077114.png" alt="Profile Photo">
            <div class="verified-info">
                <p id="verifiedAccount" class="verified-account-text" style="font-size: 10px; color: #007bff; margin-right: 15px;">Verified Account</p>
<i class="fas fa-check-circle verified-icon" style="font-size: 12px; color: #007bff;"></i>

            </div>
        </div>
        <!-- User information -->
        <h3 id="userName">Loading...</h3>
        <p id="userAge">Loading...</p>
        <p id="userRegion">Loading...</p>
        <p id="userUsername">Loading...</p>
        <p id="userGender">Loading...</p>

        <!-- Logout button -->
        <button id="logoutButton">
    <i class="fas fa-sign-out-alt"></i> Logout
</button>

    </div>
</div>

    </div>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBcTEVvxXmv5N8dJav4xNDRy5hXZRjVeM4",
            authDomain: "chatflow-59776.firebaseapp.com",
            databaseURL: "https://chatflow-59776-default-rtdb.firebaseio.com",
            projectId: "chatflow-59776",
            storageBucket: "chatflow-59776.appspot.com",
            messagingSenderId: "549003131640",
            appId: "1:549003131640:web:3f4a7b8cef4c0d8a2b990d",
            measurementId: "G-V2180PR5CR"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const firestore = firebase.firestore();

// Load profile photo of the current user
firebase.auth().onAuthStateChanged((user) => {
    if (user) {
        const userEmail = user.email;
loadUserProfile(userEmail);
checkVerifiedOrNot(userEmail);
const profilesPhotoRef = firestore.collection("profilesphoto");

profilesPhotoRef.where("uploaderEmail", "==", userEmail)
    .get()
    .then((querySnapshot) => {
        let latestPhotoUrl = "user_1077114.png"; // Default profile photo
        let latestTimestamp = 0;

        querySnapshot.forEach((doc) => {
            const timestamp = doc.data().timestamp || 0;
            const photoUrl = doc.data().downloadUrl;

            if (timestamp > latestTimestamp) {
                latestTimestamp = timestamp;
                latestPhotoUrl = photoUrl;
            }
        });

        document.getElementById("currentUserProfilePhoto").src = latestPhotoUrl;
    })
    .catch((error) => {
        console.error("Error fetching profile photo:", error);
    });


document.getElementById("exploreHostBtn").addEventListener("click", function() {
    window.location.href = "host.html";
});

        // Load Personal Chat Messages
       const personalChatBtn = document.getElementById('personalChatBtn');
const groupChatBtn = document.getElementById('groupChatBtn');
// Show personal chat by default
personalChatBtn.addEventListener('click', () => {
    loadPersonalChat(userEmail); // Function to load personal chats
    personalChatBtn.classList.add('active');
    groupChatBtn.classList.remove('active');
});

// Show group chat
groupChatBtn.addEventListener('click', () => {
    loadGroupChat(userEmail); 
    groupChatBtn.classList.add('active');
    personalChatBtn.classList.remove('active');
});

// Default load of personal chats when the page is loaded
personalChatBtn.click();


    } else {
        window.location.href = "index.html";
    }
});
// Get the elements
const createButton = document.getElementById("createButton");
const createGroupDialog = document.getElementById("createGroupDialog");
const cancelGroupButton = document.getElementById("cancelGroupButton");
const saveGroupButton = document.getElementById("saveGroupButton");
const groupNameInput = document.getElementById("groupName");

// Show the dialog when create button is clicked
createButton.addEventListener("click", () => {
    createGroupDialog.style.display = "flex";  // Show the dialog
});



// Close the dialog when cancel is clicked
cancelGroupButton.addEventListener("click", () => {
    createGroupDialog.style.display = "none";  // Hide the dialog
});

// Save the group and member information to Firebase when save is clicked
saveGroupButton.addEventListener("click", async () => {
    const groupName = groupNameInput.value.trim();
    
    if (groupName === "") {
        alert("Please enter a group name");
        return;
    }

    const currentUserEmail = firebase.auth().currentUser.email; // Get current user email
    const timestamp = Date.now(); // Current timestamp

    try {
        // Create a new group in the 'grouping' collection
        const groupRef = await firestore.collection("grouping").add({
            groupname: groupName,
            owner: currentUserEmail,
            timestamp: timestamp
        });

        // Create memberId (UUID.randomUUID().toString()) for the current user
        const memberId = generateUUID(); // Assuming generateUUID() creates a UUID string
        const memberRef = groupRef.collection("members").doc(memberId);

        // Save the current user's email and timestamp under members subcollection
        await memberRef.set({
            email: currentUserEmail,
            timestamp: timestamp
        });

        alert("Group created successfully!");
        createGroupDialog.style.display = "none";  // Close the dialog after saving

    } catch (error) {
        console.error("Error creating group: ", error);
        alert("Error creating group");
    }
});

// Utility function to generate UUID (replace this with any UUID generation logic you want)
function generateUUID() {
    // Example UUID generation (you can replace this with a real UUID generation method)
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}
function checkVerifiedOrNot(userEmail) {
    // Reference to the 'verificationbridge' collection in Firestore
    const verificationRef = firestore.collection("verificationbridge");

    // Query the collection to find the document with the userEmail
    verificationRef.where("email", "==", userEmail)
        .get()
        .then((snapshot) => {
            const verifiedInfo = document.querySelector(".verified-info");
            if (!snapshot.empty) {
                // If document exists, the user is verified
                verifiedInfo.style.display = "flex"; // Show the entire verified-info section
            } else {
                // If no matching document is found, hide the verified-info section
                verifiedInfo.style.display = "none";
            }
        })
        .catch((error) => {
            console.error("Error checking verification status:", error);
        });
}

function navigateToSearch() {
    // Add a fade-out effect before navigation
    document.body.classList.add('fade-out');

    // Wait for the animation to complete before redirecting
    setTimeout(() => {
        window.location.href = "search.html";
    }, 500); // Match this duration to the CSS animation timing
}
function loadPersonalChat(userEmail) {
    const chatContainer = document.getElementById("chatItemsContainer");
    chatContainer.innerHTML = "";

    const messagesRef = firestore.collection("messages");

    // Query for messages where current user is either sender or receiver
    messagesRef.where("senderEmail", "==", userEmail)
        .get()
        .then((querySnapshot) => {
            const chatItemsMap = {};

            // Processing messages where the current user is the sender
            querySnapshot.forEach((doc) => {
                const receiverEmail = doc.data().receiverEmail;
                const sentTime = doc.data().sentTime;
                const text = doc.data().text;

                if (!chatItemsMap[receiverEmail]) {
                    chatItemsMap[receiverEmail] = { lastMessage: "", partnerName: "", partnerPhotoUrl: "", sentTime: 0 };
                }

                if (sentTime > chatItemsMap[receiverEmail].sentTime) {
                    chatItemsMap[receiverEmail].lastMessage = text || "No message";
                    chatItemsMap[receiverEmail].sentTime = sentTime;
                }
            });

            // Now, fetch messages where current user is the receiver
            messagesRef.where("receiverEmail", "==", userEmail)
                .get()
                .then((querySnapshot) => {

                    // Processing messages where the current user is the receiver
                    querySnapshot.forEach((doc) => {
                        const senderEmail = doc.data().senderEmail;
                        const sentTime = doc.data().sentTime;
                        const text = doc.data().text;

                        if (!chatItemsMap[senderEmail]) {
                            chatItemsMap[senderEmail] = { lastMessage: "", partnerName: "", partnerPhotoUrl: "", sentTime: 0 };
                        }

                        if (sentTime > chatItemsMap[senderEmail].sentTime) {
                            chatItemsMap[senderEmail].lastMessage = text || "No message";
                            chatItemsMap[senderEmail].sentTime = sentTime;
                        }
                    });

                    // Now, prepare the sorted list
                    const sortedChatItems = Object.keys(chatItemsMap)
                        .map(senderEmail => ({
                            senderEmail,
                            ...chatItemsMap[senderEmail]
                        }))
                        .sort((a, b) => b.sentTime - a.sentTime);

                    // Display the sorted chat items
                    sortedChatItems.forEach(chatData => {
                        const senderEmail = chatData.senderEmail;

                        const profilesPhotoRef = firestore.collection("profilesphoto");
                        profilesPhotoRef.where("uploaderEmail", "==", senderEmail).get().then((photoSnapshot) => {
                            let partnerPhotoUrl = "user_1077114.png"; // Default profile image
                            photoSnapshot.forEach((photoDoc) => {
                                partnerPhotoUrl = photoDoc.data().downloadUrl;
                            });

                            const namesRef = firestore.collection("names");
                            namesRef.where("email", "==", senderEmail).get().then((nameSnapshot) => {
                                if (nameSnapshot.empty) return;

                                let partnerName = "";
                                nameSnapshot.forEach((nameDoc) => {
                                    partnerName = nameDoc.data().name || "No Name";
                                });

                                const verificationRef = firestore.collection("verificationbridge");
                                verificationRef.where("email", "==", senderEmail).get().then((verificationSnapshot) => {
                                    const isVerified = !verificationSnapshot.empty;

                                    const chatItem = document.createElement("div");
                                    chatItem.classList.add("chat-item");
                                    chatItem.id = senderEmail;
                                    chatItem.addEventListener("contextmenu", (e) => {
                                        e.preventDefault();
                                        showContextMenu(e, userEmail, senderEmail, chatItem);
                                    });
                                    chatItem.addEventListener("click", () => {
                                        window.location.href = `chat_layout.html?name=${encodeURIComponent(partnerName)}&email=${encodeURIComponent(senderEmail)}`;
                                    });

                                    const partnerPhoto = document.createElement("img");
                                    partnerPhoto.classList.add("profile-photo");
                                    partnerPhoto.src = partnerPhotoUrl;
                                    chatItem.appendChild(partnerPhoto);

                                    const info = document.createElement("div");
                                    info.classList.add("chat-item-content");

                                    const nameRow = document.createElement("div");
                                    nameRow.style.display = "flex";
                                    nameRow.style.alignItems = "center";

                                    const name = document.createElement("span");
                                    name.classList.add("name");
                                    name.innerText = partnerName;
                                    nameRow.appendChild(name);

                                    if (isVerified) {
                                       
                                        const verificationIcon = document.createElement("img");
                                        verificationIcon.src = "verification.png";
                                        verificationIcon.style.width = "14px";
                                        verificationIcon.style.height = "14px";
                                        verificationIcon.style.marginLeft = "5px";

                                        
                                        nameRow.appendChild(verificationIcon);
                                    }

                                    info.appendChild(nameRow);

                                    const lastMessage = document.createElement("p");
                                    lastMessage.classList.add("lastMessage");

                                    // Check if the last message is an image or video URL
                                    if (isImageUrl(chatData.lastMessage)) {
                                        lastMessage.innerText = "Image message";
                                        lastMessage.style.color = "blue";
                                    } else if (isVideoUrl(chatData.lastMessage)) {
                                        lastMessage.innerText = "Video message";
                                        lastMessage.style.color = "blue";
                                    } else {
                                        lastMessage.innerText = chatData.lastMessage || "No message";
                                    }

                                    info.appendChild(lastMessage);

                                    const timestamp = document.createElement("span");
                                    timestamp.classList.add("timestamp");
                                    timestamp.innerText = new Date(chatData.sentTime).toLocaleString();
                                    info.appendChild(timestamp);

                                    chatItem.appendChild(info);
                                    chatContainer.appendChild(chatItem);
                                });
                            });
                        });
                    });

                })
                .catch((error) => {
                    console.error("Error fetching messages:", error);
                });
        })
        .catch((error) => {
            console.error("Error fetching messages:", error);
        });
}

function deleteChat(userEmail, receiverEmail, chatItem) {
    const messagesRef = firestore.collection("messages");

    messagesRef.where("senderEmail", "==", userEmail)
        .get()
        .then((querySnapshot) => {
            const batch = firestore.batch();
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                if (data.receiverEmail === receiverEmail) {
                    batch.delete(doc.ref);
                }
            });

            return messagesRef.where("senderEmail", "==", receiverEmail).get().then((reverseSnapshot) => {
                reverseSnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.receiverEmail === userEmail) {
                        batch.delete(doc.ref);
                    }
                });

                return batch.commit();
            });
        })
        .then(() => {
            chatItem.remove();
            alert("Chat deleted successfully.");
        })
        .catch((error) => {
            console.error("Error deleting chat:", error);
        });
}

function copyChat(userEmail, receiverEmail) {
    const messagesRef = firestore.collection("messages");

    messagesRef.where("senderEmail", "==", userEmail)
        .get()
        .then((querySnapshot) => {
            const messages = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                if (data.receiverEmail === receiverEmail) {
                    messages.push(`${data.sentTime}: ${data.text}`);
                }
            });

            return messagesRef.where("senderEmail", "==", receiverEmail).get().then((reverseSnapshot) => {
                reverseSnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.receiverEmail === userEmail) {
                        messages.push(`${data.sentTime}: ${data.text}`);
                    }
                });

                // Copy messages to clipboard
                navigator.clipboard.writeText(messages.join("\n"))
                    .then(() => alert("Messages copied to clipboard."))
                    .catch((err) => console.error("Error copying messages:", err));
            });
        })
        .catch((error) => {
            console.error("Error fetching messages for copy:", error);
        });
}
document.getElementById("sidebarToggle").addEventListener("click", function () {
    const mainContainer = document.querySelector(".main-container");
    mainContainer.classList.toggle("sidebar-open");

    // Change icon between sidebar and back
    this.innerHTML = mainContainer.classList.contains("sidebar-open")
        ? '<i class="fas fa-arrow-left" style="color: black;"></i>' // Back icon
        : '<i class="fas fa-bars" style="color: black;"></i>'; // Sidebar icon
});


function showContextMenu(event, userEmail, receiverEmail, chatItem) {
    // Prevent default context menu
    event.preventDefault();

    // Remove any existing context menu
    const existingMenu = document.querySelector(".context-menu");
    if (existingMenu) existingMenu.remove();

    // Create the context menu container
    const contextMenu = document.createElement("div");
    contextMenu.classList.add("context-menu");

    // Create Delete option
    const deleteOption = document.createElement("div");
    deleteOption.classList.add("context-menu-item");
    deleteOption.innerHTML = `<i class="fas fa-trash-alt"></i> Delete`;
    deleteOption.addEventListener("click", () => {
        deleteChat(userEmail, receiverEmail, chatItem);
        contextMenu.remove(); // Remove menu after action
    });
    contextMenu.appendChild(deleteOption);

    // Create Copy option
    const copyOption = document.createElement("div");
    copyOption.classList.add("context-menu-item");
    copyOption.innerHTML = `<i class="fas fa-copy"></i> Copy`;
    copyOption.addEventListener("click", () => {
        copyChat(userEmail, receiverEmail);
        contextMenu.remove(); // Remove menu after action
    });
    contextMenu.appendChild(copyOption);

    // Append context menu to the document body
    document.body.appendChild(contextMenu);

    // Position the menu at the cursor's location
    contextMenu.style.top = `${event.clientY}px`;
    contextMenu.style.left = `${event.clientX}px`;

    // Remove menu on outside click
    document.addEventListener("click", () => contextMenu.remove(), { once: true });
}

 function isImageUrl(text) {
    return text.startsWith("https://firebasestorage.googleapis.com") && text.includes("/sentphotos%2F");
}

function isVideoUrl(text) {
    return text.startsWith("https://firebasestorage.googleapis.com") && text.includes("/sentvideos%2F");
}

function showAddMembersDialog(groupId, groupName) {
    // Create the dialog container
    const dialogContainer = document.createElement("div");
    dialogContainer.classList.add("add-members-dialog");

    const dialogContent = document.createElement("div");
    dialogContent.classList.add("dialog-content");

    const dialogTitle = document.createElement("h3");
    dialogTitle.textContent = `Add Members to ${groupName}`;
    dialogContent.appendChild(dialogTitle);

    const chatItemsContainer = document.createElement("div");
    chatItemsContainer.classList.add("chat-items-container");

    // Fetch and display personal chats
    loadPersonalChatForAddingMembers(chatItemsContainer, groupId);

    // Buttons
    const saveButton = document.createElement("savebutton");
    saveButton.textContent = "Save";
    saveButton.style.display = "none"; // Initially hidden
    saveButton.addEventListener("click", function () {
        saveSelectedMembers(groupId);
    });

    const cancelButton = document.createElement("cancelbutton");
    cancelButton.textContent = "Cancel";
    cancelButton.addEventListener("click", function () {
        dialogContainer.remove();
    });

    dialogContent.appendChild(chatItemsContainer);
    dialogContent.appendChild(saveButton);
    dialogContent.appendChild(cancelButton);

    dialogContainer.appendChild(dialogContent);
    document.body.appendChild(dialogContainer);

    // Show save button only when there is at least one selected item
    chatItemsContainer.addEventListener("click", () => {
        const selectedItems = chatItemsContainer.querySelectorAll(".select-chat-item.selected");
        saveButton.style.display = selectedItems.length > 0 ? "inline-block" : "none";
    });
}
function loadPersonalChatForAddingMembers(container, groupId) {
    const db = firebase.firestore();
    const chatRef = db.collection("messages");
    const verificationRef = db.collection("verificationbridge");
    const userEmail = firebase.auth().currentUser.email;

    const addedEmails = new Set(); // To avoid duplicates
    let pendingPromises = []; // Track promises to determine completion

    chatRef.where("senderEmail", "==", userEmail)
        .get()
        .then((querySnapshot) => {
            querySnapshot.forEach((doc) => {
                const receiverEmail = doc.data().receiverEmail;

                if (!addedEmails.has(receiverEmail)) {
                    addedEmails.add(receiverEmail); // Add to the set to prevent duplicates

                    const promise = isMemberInGroup(groupId, receiverEmail).then((isMember) => {
                        if (!isMember) {
                            return fetchUserProfile(receiverEmail).then(({ name, photoUrl }) => {
                                // Create the select-chat-item element
                                const chatItem = document.createElement("div");
                                chatItem.classList.add("select-chat-item");
                                chatItem.id = receiverEmail;

                                const profilePhoto = document.createElement("img");
                                profilePhoto.classList.add("select-profile-photo");
                                profilePhoto.src = photoUrl;

                                const nameElement = document.createElement("span");
                                nameElement.classList.add("select-name");
                                nameElement.innerText = name;

                                // Blue "Echo" label
                                const echoLabel = document.createElement("span");
                                echoLabel.classList.add("select-echo");
                                echoLabel.innerText = "Echo";
                                echoLabel.style.display = "none"; // Initially hidden

                                // Verification icon
                                const verificationIcon = document.createElement("img");
                                verificationIcon.classList.add("select-verification");
                                verificationIcon.src = "verification.jpg";
                                verificationIcon.style.display = "none"; // Initially hidden

                                // Check verificationbridge collection
                                const verificationPromise = verificationRef
                                    .where("email", "==", receiverEmail)
                                    .get()
                                    .then((verificationSnapshot) => {
                                        if (!verificationSnapshot.empty) {
                                            echoLabel.style.display = "inline";
                                            verificationIcon.style.display = "inline";
                                        }
                                    });

                                pendingPromises.push(verificationPromise);

                                // Append elements to the select-chat-item
                                chatItem.appendChild(profilePhoto);
                                chatItem.appendChild(nameElement);
                                chatItem.appendChild(echoLabel);
                                chatItem.appendChild(verificationIcon);

                                // Click event to toggle selection
                                chatItem.addEventListener("click", function () {
                                    chatItem.classList.toggle("selected");
                                });

                                // Append chat item to the container
                                container.appendChild(chatItem);
                            });
                        }
                    });

                    pendingPromises.push(promise);
                }
            });

            // Wait for all promises to resolve
            return Promise.all(pendingPromises);
        })
        .then(() => {
            // Check if the container is still empty after all processing
            if (container.childElementCount === 0) {
                displayNoPartnerMessage(container);
            }
        })
        .catch((error) => {
            console.error("Error fetching personal chats:", error);
        });
}

function displayNoPartnerMessage(container) {
    // Clear the container
    container.innerHTML = "";

    // Create the message element
    const messageElement = document.createElement("div");
    messageElement.classList.add("no-partner-message");

    // Set the message text
    messageElement.innerHTML = `
        <p>No partner to add!</p>
        <p>That is why, send to other new users and add them to this group!</p>
    `;

    // Append the message to the container
    container.appendChild(messageElement);
}



function saveSelectedMembers(groupId) {
    const selectedChatItems = document.querySelectorAll(".chat-item.selected");
    const db = firebase.firestore();
    const membersCollection = db.collection("grouping").doc(groupId).collection("members");

    selectedChatItems.forEach(chatItem => {
        const email = chatItem.id;
        const memberId = generateUUID();

        membersCollection.doc(memberId).set({
            email: email,
            timestamp: Date.now() // Save current time in milliseconds
        }).then(() => {
            console.log(`Member ${email} added successfully!`);
        }).catch(error => {
            console.error(`Error adding member ${email}:`, error);
        });
    });

    // Close the dialog after saving
    document.querySelector(".add-members-dialog").remove();
}


function fetchUserProfile(email) {
    const db = firebase.firestore();
    const namesRef = db.collection("names");
    const profilesPhotoRef = db.collection("profilesphoto");

    return Promise.all([
        getLatestName(namesRef, email),
        getLatestProfilePhoto(profilesPhotoRef, email)
    ])
    .then(([name, photoUrl]) => {
        return { name, photoUrl };
    })
    .catch((error) => {
        console.error("Error fetching profile info:", error);
        return { name: "No name found", photoUrl: "defaultProfilePhoto.jpg" }; // Default values
    });
}

function getLatestName(namesRef, email) {
    return namesRef.where("email", "==", email).get().then((snapshot) => {
        let latestName = "No name found";
        let lastTimestamp = 0;

        snapshot.forEach((doc) => {
            const timestamp = doc.get("timestamp") || 0;
            const name = doc.get("name");

            if (timestamp > lastTimestamp && name) {
                lastTimestamp = timestamp;
                latestName = name;
            }
        });
        return latestName;
    });
}

function getLatestProfilePhoto(profilesPhotoRef, email) {
    return profilesPhotoRef.where("uploaderEmail", "==", email).get().then((querySnapshot) => {
        let latestPhotoUrl = "defaultProfilePhoto.jpg"; // Fallback photo
        let latestTimestamp = 0;

        querySnapshot.forEach((doc) => {
            const timestamp = doc.data().timestamp || 0;
            const photoUrl = doc.data().downloadUrl;

            if (timestamp > latestTimestamp) {
                latestTimestamp = timestamp;
                latestPhotoUrl = photoUrl;
            }
        });
        return latestPhotoUrl;
    });
}
function isMemberInGroup(groupId, receiverEmail) {
    const db = firebase.firestore();
    return db.collection("grouping")
        .doc(groupId)
        .collection("members")
        .where("email", "==", receiverEmail)
        .get()
        .then(snapshot => !snapshot.empty);
}

// Helper function to check if a text is a video URL
function isGroupVideoUrl(text) {
    return text.startsWith("https://firebasestorage.googleapis.com") &&
           text.includes("/groupsentvideos%2F");
}
function loadGroupChat(userEmail) {
    const chatContainer = document.getElementById("chatItemsContainer");
    if (!chatContainer) {
        console.error("Chat container not found.");
        return;
    }
    chatContainer.innerHTML = ""; // Clear the container

    const db = firebase.firestore();
    const groupingRef = db.collection("grouping");

    // Fetch groups where the user is a member
    groupingRef.get().then((groupDocuments) => {
        if (groupDocuments.empty) {
            console.log("No groups found.");
            return;
        }

        groupDocuments.forEach((groupDoc) => {
            const groupId = groupDoc.id;
            const groupName = groupDoc.get("groupname") || "Unknown Group";

            // Check if the user is a member of the group
            groupingRef
                .doc(groupId)
                .collection("members")
                .where("email", "==", userEmail)
                .get()
                .then((memberDocuments) => {
                    if (!memberDocuments.empty) {
                        loadGroupMessages(groupId, groupName);
                    }
                })
                .catch((error) => {
                    console.error("Error checking group members:", error.message);
                });
        });
    }).catch((error) => {
        console.error("Error fetching groups:", error.message);
    });
}
function loadGroupMessages(groupId, groupName) {
    const db = firebase.firestore();
    const groupMessagesRef = db.collection("groupchat").doc(groupId).collection("groupmessages");

    groupMessagesRef.get().then((querySnapshot) => {
        const messages = querySnapshot.docs
            .map((doc) => {
                const messageText = doc.get("text") || "";
                const sentTime = doc.get("sentTime") || 0;

                // Ensure sentTime is a valid timestamp and convert to a JavaScript Date if needed
                const messageSentTime = sentTime instanceof firebase.firestore.Timestamp
                    ? sentTime.toDate()
                    : new Date(sentTime);

                return {
                    messageText,
                    sentTime: messageSentTime,
                };
            })
            .sort((a, b) => b.sentTime - a.sentTime); // Sort by sentTime in descending order

        const latestMessage = messages.length > 0 ? messages[0].messageText : "Group created";
        const latestSentTime = messages.length > 0 ? messages[0].sentTime : 0;

        loadGroupProfilePhoto(groupId, (profilePhotoUrl) => {
            displayGroupInfo(groupId, groupName, latestMessage, latestSentTime, profilePhotoUrl);
        });
    }).catch((error) => {
        console.error("Error fetching group messages:", error.message);
    });
}

function loadGroupProfilePhoto(groupId, callback) {
    const db = firebase.firestore();
    const groupRef = db.collection("grouping").doc(groupId);

    groupRef.get().then((groupDoc) => {
        const profilePhotoUrl = groupDoc.get("profilePhotoUrl") || "group.jpg";
        callback(profilePhotoUrl);
    }).catch((error) => {
        console.error("Error fetching group profile photo:", error.message);
        callback("group.jpg"); // Default photo in case of error
    });
}

function displayGroupInfo(groupId, groupName, lastMessage, timestamp, profilePhotoUrl) {
    const chatContainer = document.getElementById("chatItemsContainer");
    if (!chatContainer) return;

    const groupElement = document.createElement("div");
    groupElement.classList.add("group-chat");

    // Profile image
    const profileImageElement = document.createElement("img");
    profileImageElement.src = profilePhotoUrl || "group.jpg";
    profileImageElement.classList.add("profile-image");

    // Group info container
    const groupInfoContainer = document.createElement("div");
    groupInfoContainer.classList.add("group-info");

    // Group name
    const groupNameElement = document.createElement("h3");
    groupNameElement.textContent = groupName;

    // Last message
    const lastMessageElement = document.createElement("p");
    if (isGroupVideoUrl(lastMessage)) {
        lastMessageElement.textContent = "Video Message";
        lastMessageElement.style.color = "blue";
    } else if (isGroupImageUrl(lastMessage)) {
        lastMessageElement.textContent = "Image Message";
        lastMessageElement.style.color = "blue";
    } else {
        lastMessageElement.textContent = lastMessage;
    }

    // Timestamp
    const timestampElement = document.createElement("span");
    timestampElement.textContent = new Date(timestamp).toLocaleString();

    // Append elements
    groupInfoContainer.append(groupNameElement, lastMessageElement, timestampElement);
    groupElement.append(profileImageElement, groupInfoContainer);

    // Left-click event
    groupElement.addEventListener("click", (event) => {
        if (event.button === 0) {
            window.location.href = `group_chat_layout.html?groupId=${groupId}&groupName=${encodeURIComponent(groupName)}`;
        }
    });

    // Right-click event
    groupElement.addEventListener("contextmenu", (event) => {
        event.preventDefault();
        showAddMembersDialog(groupId, groupName);
    });

    chatContainer.appendChild(groupElement);
}


// Helper function to check if a text is an image URL
function isGroupImageUrl(text) {
    return text.startsWith("https://firebasestorage.googleapis.com") &&
           (text.includes("/groupsentphotos%2F") || text.includes("/groupsentvideos%2F"));
}

        document.getElementById("logoutButton").addEventListener("click", () => {
    firebase.auth().signOut()
        .then(() => {
            window.location.href = "index.html";
        })
        .catch((error) => {
            console.error("Error logging out:", error.message);
        });
});

function loadUserProfile(userEmail) {
   
   
    fetchAndDisplayName(userEmail);
    fetchAndDisplayAge(userEmail);
    fetchAndDisplayRegion(userEmail);
    fetchAndDisplayUsername(userEmail);
    fetchAndDisplayGender(userEmail);
}

    // Fetch and display the latest name based on the timestamp
    function fetchAndDisplayName(email) {
        const namesRef = firestore.collection("names");
        namesRef.where("email", "==", email).get().then((snapshot) => {
            let lastTimestamp = 0;
            let latestName = null;

            snapshot.forEach((doc) => {
                const timestamp = doc.get("timestamp") || 0;
                const name = doc.get("name");

                if (timestamp > lastTimestamp && name) {
                    lastTimestamp = timestamp;
                    latestName = name;
                }
            });

            document.getElementById("userName").innerText = latestName || "No name found";
        }).catch((error) => {
            console.error("Error fetching name:", error);
        });
    }

    function fetchAndDisplayAge(email) {
    const agesRef = firestore.collection("ages");  // Reference to the 'ages' collection
    agesRef.where("email", "==", email).get().then((snapshot) => {
        let lastTimestamp = 0;
        let latestAge = "Unknown";

        snapshot.forEach((doc) => {
            const timestamp = doc.get("timestamp") || 0;
            const age = doc.get("birthdate");

            if (timestamp > lastTimestamp && age) {
                lastTimestamp = timestamp;
                latestAge = age;
            }
        });

        document.getElementById("userAge").innerText = latestAge || "Unknown";
    }).catch((error) => {
        console.error("Error fetching age:", error);
    });
}


    // Fetch and display the region
    function fetchAndDisplayRegion(email) {
        const locationRef = firestore.collection("locations");
        locationRef.where("email", "==", email).get().then((snapshot) => {
            let region = "Region not found";

            snapshot.forEach((doc) => {
                const continent = doc.get("continent");
                const country = doc.get("country");
                region = continent && country ? `${continent}/${country}` : "Region not found";
            });

            document.getElementById("userRegion").innerText = region;
        }).catch((error) => {
            console.error("Error fetching region:", error);
        });
    }

    // Fetch and display the latest username based on timestamp
    function fetchAndDisplayUsername(email) {
        const usernameRef = firestore.collection("usernameSet");
        usernameRef.where("email", "==", email).get().then((snapshot) => {
            let latestUsername = null;
            let lastTimestamp = 0;

            snapshot.forEach((doc) => {
                const timestamp = doc.get("timestamp") || 0;
                const username = doc.get("username");

                if (timestamp > lastTimestamp && username) {
                    lastTimestamp = timestamp;
                    latestUsername = username;
                }
            });

            const usernameTextView = document.getElementById("userUsername");
            if (latestUsername) {
                usernameTextView.innerText = latestUsername;

                // Click listener to go to SetNewUsernameActivity
                usernameTextView.onclick = () => {
                    window.location.href = "SetNewUsernameActivity.html";
                };

                // Long click listener to copy username to clipboard
                usernameTextView.oncontextmenu = (e) => {
                    e.preventDefault();
                    navigator.clipboard.writeText(latestUsername).then(() => {
                        alert("Username copied to clipboard");
                    });
                };
            } else {
                usernameTextView.innerText = "No username found";
            }
        }).catch((error) => {
            console.error("Error fetching username:", error);
        });
    }

    // Fetch and display the gender
    function fetchAndDisplayGender(email) {
        const genderRef = firestore.collection("genders");
        genderRef.where("email", "==", email).get().then((snapshot) => {
            let gender = "Unknown";

            snapshot.forEach((doc) => {
                gender = doc.get("gender") || "Unknown";
            });

            document.getElementById("userGender").innerText = gender;
        }).catch((error) => {
            console.error("Error fetching gender:", error);
        });
    }

        function toggleSidebar() {
            const sidebar = document.getElementById("sidebar");
            sidebar.classList.toggle("open");
        }

        document.getElementById("profilePhoto").addEventListener("click", toggleSidebar);
    </script>
</body>
</html>
